# Technical Debt Registry

このドキュメントは、Shirokuma MCP Knowledge Baseの技術的負債を追跡・管理するためのものです。

## 優先度の定義

- **Critical**: システムの安定性やセキュリティに影響
- **High**: 開発効率や保守性に大きく影響
- **Medium**: 改善が望ましいが、直ちに対処する必要はない
- **Low**: 将来的に対処すべき項目

## 現在の技術的負債

### 1. E2Eテストの実行問題

**優先度**: High  
**カテゴリ**: テスト  
**追加日**: 2025-01-27

**問題**:
- MCP SDKのモジュール解決問題によりE2Eテストが標準テストスイートから除外されている
- カスタムランナーを使用しているが、CI/CDパイプラインに統合されていない

**影響**:
- エンドツーエンドの動作保証が手動テストに依存
- リグレッションの早期発見が困難

**解決案**:
1. MCP SDKの問題が解決されるのを待つ
2. 代替のE2Eテストフレームワークを検討
3. 統合テストでカバー範囲を拡大

**関連Issue**: #TODO

---

### 2. any型の使用（意図的）

**優先度**: Medium  
**カテゴリ**: 型安全性  
**追加日**: 2025-01-29

**問題**:
いくつかの箇所で意図的にany型を使用している：
- SQLiteパラメータ配列（混合型）
- YAMLフロントマター（任意の構造）
- Winstonトランスポート（型定義の不足）

**影響**:
- 型安全性の低下
- 潜在的なランタイムエラー

**解決案**:
1. Union型やジェネリクスで置き換え可能か検討
2. 型定義ファイルの作成
3. より厳密な型ガードの実装

**コード例**:
```typescript
// 現在
let params: any[] = [`"${escapedQuery}"`, limit, offset];

// 改善案
type SQLParam = string | number | boolean | null;
let params: SQLParam[] = [`"${escapedQuery}"`, limit, offset];
```

---

### 3. データベース接続管理

**優先度**: Medium  
**カテゴリ**: パフォーマンス  
**追加日**: 2025-01-26

**問題**:
- リクエストごとに新しい接続を作成している
- 接続プーリングが実装されていない
- 各リクエストで10-15msのオーバーヘッド

**影響**:
- 高負荷時のパフォーマンス低下
- リソースの無駄な使用

**解決案**:
1. SQLite接続プーリングの実装
2. 永続的な接続の管理
3. 接続の再利用メカニズム

**トレードオフ**:
現在の設計は、データベース再構築時の自動回復を提供している

---

### 4. エラーメッセージの国際化

**優先度**: Low  
**カテゴリ**: ユーザビリティ  
**追加日**: 2025-01-28

**問題**:
- エラーメッセージが英語のみ
- 日本語ドキュメントはあるが、実行時メッセージは英語

**影響**:
- 非英語圏ユーザーの利便性低下
- エラーの理解が困難

**解決案**:
1. i18nフレームワークの導入
2. メッセージカタログの作成
3. ロケール検出機能の実装

---

### 5. セッションファイルの増加

**優先度**: Medium  
**カテゴリ**: スケーラビリティ  
**追加日**: 2025-01-29

**問題**:
- セッションファイルが日付ディレクトリに蓄積
- 古いセッションの自動削除機能がない
- 長期運用でディスク容量を圧迫する可能性

**影響**:
- ディスク容量の無駄な使用
- ファイルシステムのパフォーマンス低下

**解決案**:
1. セッションのアーカイブ機能
2. 古いセッションの自動削除
3. セッションの圧縮保存

---

### 6. 検索クエリの最適化

**優先度**: Low  
**カテゴリ**: パフォーマンス  
**追加日**: 2025-01-27

**問題**:
- FTS5の高度な機能が未使用
- 検索結果のランキングが基本的
- ファセット検索が未実装

**影響**:
- 検索精度の低下
- ユーザーが目的の情報を見つけにくい

**解決案**:
1. FTS5のランキング機能を活用
2. ファセット検索の実装
3. 検索クエリの最適化

---

## 解決済みの技術的負債

### ✓ any型の大量使用

**解決日**: 2025-01-29  
**解決方法**: 
- 249個のany型を0に削減
- 適切な型定義とインターフェースを作成
- 必要な箇所のみ`@ai-any-deliberate`で文書化

### ✓ テストカバレッジ不足

**解決日**: 2025-01-29  
**解決方法**:
- カバレッジを44.54%から80.33%に改善
- 500以上の新しいテストを追加
- セキュリティとエッジケースのテストを強化

### ✓ 未使用コード

**解決日**: 2025-01-29  
**解決方法**:
- 11ファイル、約1500行の未使用コードを削除
- デッドコード検出の自動化

## 技術的負債の管理プロセス

### 1. 識別

- コードレビュー時に技術的負債を識別
- `// TODO: `コメントで一時的な解決策をマーク
- 定期的なコードベース監査

### 2. 文書化

- このドキュメントに追加
- 優先度とカテゴリを設定
- 影響と解決案を記載

### 3. 計画

- 四半期ごとに技術的負債の見直し
- 優先度に基づいて対処計画を作成
- リファクタリングスプリントの実施

### 4. 解決

- 専用のブランチで作業
- テストを追加してリグレッションを防ぐ
- 解決後は「解決済み」セクションに移動

## メトリクス

### 現在の状態（2025-01-29）

- **総項目数**: 6
- **Critical**: 0
- **High**: 1
- **Medium**: 3
- **Low**: 2

### 目標

- 四半期ごとにHigh優先度の項目を1つ以上解決
- 新規追加を最小限に抑える
- 技術的負債の総量を減少傾向に保つ