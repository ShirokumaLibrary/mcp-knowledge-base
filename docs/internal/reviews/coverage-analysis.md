# テストカバレッジ分析 - なぜ80%到達が困難か

## 現状のカバレッジ: 77.86%

## カバレッジが低い主要ファイルと理由

### 1. **rebuild-db.ts (0%)**
**理由**: スタンドアロンのCLIツール
- ファイルシステムとデータベースを直接操作
- `process.exit()`を使用
- データベースファイルの削除・再作成を行う破壊的操作
- テストすると実際のデータベースに影響を与える

**対策の難しさ**: 
- モック化が困難（ファイルシステムとSQLiteの両方を模倣する必要）
- 副作用が大きい（データベース全体の再構築）

### 2. **tool-definitions.ts (0%)**
**理由**: 静的な設定ファイル
- MCPツール定義のJSON構造のみ
- ロジックなし、エクスポートされた定数のみ
- 実行可能なコードは1行（export文）のみ

**対策の難しさ**: 
- テストする意味がない（設定値の検証はスキーマテストで十分）

### 3. **config/constants.ts (0%)**
**理由**: 定数定義ファイル
- 静的な設定値とマッピングのみ
- ビジネスロジックなし

**対策の難しさ**: 
- テストの価値が低い（定数の値をテストしても意味がない）

### 4. **status-repository.ts (21.21%)**
**理由**: レガシーコード
- 新しいstatus-repository-v2.tsに置き換えられつつある
- 古いAPIとの互換性のために残されている
- 統合テストでは新しいバージョンを使用

**対策の難しさ**: 
- 削除予定のコードに工数をかける価値がない

### 5. **base-repository.ts (61.4%)**
**理由**: 抽象基底クラス
- エラーハンドリングの多くの分岐
- ファイルI/Oエラーの全パターンをテストするのが困難
- プライベートメソッドが多い

**対策の難しさ**: 
- エラーケースの網羅的なテストが必要
- ファイルシステムのモック化が複雑

### 6. **logger.ts (55.55%)**
**理由**: 外部依存が多い
- console出力の制御
- 環境変数依存
- 開発/本番環境の切り替えロジック

**対策の難しさ**: 
- console.logのモック化
- 環境変数の操作

### 7. **item-repository.ts (50.84%)** と **tag-repository.ts (53.84%)**
**理由**: データベース操作の複雑さ
- SQLiteトランザクション処理
- 多数のエッジケース
- ファイルとDBの同期処理

**対策の難しさ**: 
- トランザクションロールバックのテスト
- 並行処理のテスト
- DBとファイルの不整合状態のテスト

### 8. **session-repository.ts (51.75%)**
**理由**: 複雑な日付処理
- タイムゾーン処理
- 日付フォーマット変換
- ディレクトリ構造の管理

**対策の難しさ**: 
- 日付関連のエッジケース
- ファイルシステム操作のモック

## カバレッジ向上の現実的な戦略

### すぐに改善可能（工数: 小）
1. **repository-helpers.ts (56.41%)**: ユーティリティ関数のテスト追加
2. **unified-storage.ts (79.54%)**: エラーケースのテスト追加

### 改善可能だが工数大
1. **base-repository.ts**: エラーハンドリングの網羅的テスト
2. **item-repository.ts**: エッジケースのテスト追加

### 改善の価値が低い
1. **rebuild-db.ts**: E2Eテストで間接的にカバー
2. **tool-definitions.ts**, **constants.ts**: 静的設定
3. **status-repository.ts**: レガシーコード

## 結論

現在の77.86%から80%への到達は可能ですが、以下の理由で慎重に検討すべきです：

1. **投資対効果**: 残り2.14%のために必要な工数が大きい
2. **テストの質**: 無理なカバレッジ向上は意味のないテストを生む
3. **実用的カバレッジ**: CLIツールと設定ファイルを除けば、実質的なカバレッジは既に高い

### 推奨アプローチ
1. ビジネスロジックのカバレッジ向上に集中
2. CLIツールは統合テストでカバー
3. 設定ファイルはスキーマ検証で品質保証
4. レガシーコードは段階的に新実装に移行