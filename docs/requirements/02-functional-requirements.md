# 機能要件書

## 1. 概要

本書は、Shirokuma MCP Knowledge Base v0.8.0の機能要件を定義します。システムが提供すべき機能、ユーザーインタラクション、データ処理について詳細に記述します。

## 2. システム機能要件

### 2.1 統一Itemモデル管理

#### FR-001: 統一データモデル
- **説明**: すべてのアイテムタイプを単一のItemテーブルで管理
- **詳細**:
  - タイプは動的に作成可能（事前登録不要）
  - 全フィールドが全タイプで利用可能
  - IDは全体で一意（自動採番）

#### FR-002: 必須フィールド管理
- **説明**: すべてのアイテムが持つべき必須フィールド
- **フィールド一覧**:
  ```
  - id: 一意識別子（自動生成）
  - type: アイテムタイプ（6種類から選択）
  - title: タイトル（最大200文字）
  - description: 概要説明（最大1000文字）
  - content: 詳細内容（Markdown形式、最大100KB）
  - statusId: ステータスID（Statusテーブル参照）
  - priority: 優先度（5段階Enum）
  - createdAt: 作成日時（自動設定）
  - updatedAt: 更新日時（自動更新）
  ```

#### FR-003: オプションフィールド管理
- **説明**: 必要に応じて使用可能なフィールド
- **フィールド一覧**:
  ```
  - category: カテゴリ（自由入力文字列）
  - startDate: 開始日時
  - endDate: 終了日時
  - version: バージョン情報
  - related: 関連アイテムID配列（JSON形式）
  - tags: タグリスト（多対多リレーション）
  ```

### 2.2 タイプ管理機能

#### FR-010: 動的タイプ管理
- **説明**: タイプは事前登録不要で自由に作成可能
- **特徴**:
  - 新しいタイプは使用時に自動的に有効化
  - タイプ名は任意の文字列（推奨: 小文字英数字）
  - システムは標準タイプをガイドラインとして提供

- **推奨標準タイプ**:

| タイプ | 推奨用途 | 推奨デフォルトステータス | 推奨デフォルト優先度 |
|--------|----------|----------------------|-------------------|
| issues | 課題・バグ管理 | Open | HIGH |
| tasks | タスク管理 | Open | MEDIUM |
| docs | ドキュメント | Open | LOW |
| patterns | パターン集 | Open | LOW |
| decisions | 決定事項 | Open | MEDIUM |
| sessions | セッション記録 | Open | LOW |

#### FR-011: タイプ情報取得
- **説明**: 使用中のタイプ一覧と統計情報を取得
- **機能**:
  - 使用中のタイプ一覧取得（実際に存在するアイテムのタイプ）
  - タイプごとのアイテム数カウント
  - 最終使用日時の取得
  - 推奨タイプのガイドライン提供

#### FR-012: タイプ自動追加
- **説明**: 新しいタイプは作成時に自動的に利用可能
- **処理**:
  - アイテム作成時に新しいタイプが指定されたら自動受け入れ
  - タイプ名の妥当性チェック（特殊文字の制限等）
  - 使用統計の自動収集

### 2.3 ステータス管理機能

#### FR-020: ステータスマスタ管理
- **説明**: 12種類の必須ステータスの管理
- **ステータス一覧**:
  ```
  Open        - 新規・未着手
  Specification - 仕様策定中
  Waiting     - 待機中
  Ready       - 着手可能
  In Progress - 進行中
  Review      - レビュー中
  Testing     - テスト中
  Pending     - 保留
  Completed   - 完了
  Closed      - クローズ
  Canceled    - キャンセル
  Rejected    - 却下
  ```

#### FR-021: ステータス遷移
- **説明**: アイテムのステータス変更
- **ルール**:
  - 任意のステータスから任意のステータスへ変更可能
  - 変更履歴は updatedAt で追跡
  - isClosable フラグで終了状態を識別

#### FR-022: ステータスフィルタリング
- **説明**: ステータスによるアイテムの絞り込み
- **機能**:
  - 単一ステータスでのフィルタ
  - 複数ステータスでのフィルタ（OR条件）
  - クローズステータスの包含/除外オプション

### 2.4 優先度管理機能

#### FR-030: 5段階優先度管理
- **説明**: Priority Enumによる優先度管理
- **優先度レベル**:
  ```typescript
  enum Priority {
    CRITICAL  // 緊急対応必須
    HIGH      // 高優先度
    MEDIUM    // 通常（デフォルト）
    LOW       // 低優先度
    MINIMAL   // 最低優先度
  }
  ```

#### FR-031: 優先度による並び替え
- **説明**: 優先度を基準とした並び替え機能
- **並び順**: CRITICAL > HIGH > MEDIUM > LOW > MINIMAL

#### FR-032: 優先度フィルタリング
- **説明**: 特定優先度のアイテムのみを抽出
- **機能**: 単一または複数優先度でのフィルタリング

### 2.5 CRUD操作

#### FR-040: アイテム作成（Create）
- **説明**: 新規アイテムの作成
- **入力検証**:
  - 必須フィールドの存在確認
  - 文字数制限のチェック
  - タイプの妥当性検証
  - ステータスの存在確認
- **自動処理**:
  - ID自動採番
  - タイムスタンプ自動設定
  - デフォルト値の適用

#### FR-041: アイテム取得（Read）
- **説明**: アイテムの取得と一覧表示
- **取得方法**:
  - ID指定による単一取得
  - タイプ別一覧取得
  - 条件指定による複数取得
- **ページネーション**:
  - limit/offset方式
  - デフォルト20件、最大100件

#### FR-042: アイテム更新（Update）
- **説明**: 既存アイテムの更新
- **更新可能フィールド**:
  - title, description, content
  - status, priority
  - category, version
  - startDate, endDate
  - tags, related
- **更新不可フィールド**:
  - id, type, createdAt

#### FR-043: アイテム削除（Delete）
- **説明**: アイテムの削除
- **削除方式**:
  - 物理削除（データベースから完全削除）
  - 関連データ（タグ関連付け）も同時削除
- **制約**: 他アイテムから参照されている場合の警告

### 2.6 検索機能

#### FR-050: 全文検索
- **説明**: title, description, contentを対象とした全文検索
- **機能**:
  - キーワード検索（部分一致）
  - 複数キーワードのAND/OR検索
  - 検索結果のランキング

#### FR-051: フィルタ検索
- **説明**: 各フィールドによる絞り込み検索
- **フィルタ条件**:
  - type（単一/複数）
  - status（単一/複数）
  - priority（単一/複数）
  - category（完全一致/部分一致）
  - 日付範囲（startDate, endDate）
  - tags（タグ名での絞り込み）

#### FR-052: 関連アイテム検索
- **説明**: アイテム間の関連性による検索
- **機能**:
  - 特定アイテムの関連アイテム取得
  - 双方向関連の検索
  - 関連の深さ指定（1段階、2段階など）

#### FR-053: サジェスト機能
- **説明**: 検索入力時の自動補完
- **対象**:
  - タイトルのサジェスト
  - タグのサジェスト
  - カテゴリのサジェスト

### 2.7 タグ管理機能

#### FR-060: タグマスタ管理
- **説明**: タグの作成・管理
- **機能**:
  - 新規タグの作成
  - 既存タグの削除
  - タグ一覧の取得
  - タグ名での検索

#### FR-061: タグ付け機能
- **説明**: アイテムへのタグ付与
- **機能**:
  - 複数タグの同時付与
  - タグの削除
  - 存在しないタグの自動作成

#### FR-062: タグによる検索
- **説明**: タグを使用したアイテム検索
- **機能**:
  - 単一タグでの検索
  - 複数タグでのAND/OR検索
  - タグの利用頻度取得

### 2.8 関連管理機能

#### FR-070: 関連付け設定
- **説明**: アイテム間の関連付け
- **Phase 1実装**:
  - related フィールドにID配列をJSON形式で保存
  - 例: "[16, 2, 7]"
- **制約**:
  - 自己参照は不可
  - 存在しないIDの検証

#### FR-071: 関連アイテム取得
- **説明**: 関連アイテムの情報取得
- **機能**:
  - 直接関連アイテムの一覧取得
  - 関連アイテムの詳細情報取得
  - 関連の可視化（関連マップ）

### 2.9 セッション管理機能

#### FR-080: セッション作成
- **説明**: 作業セッションの記録
- **特別処理**:
  - startDateを必須とする
  - タイトルに日時を自動付与オプション
  - カテゴリによる分類（development, meeting等）

#### FR-081: セッション更新
- **説明**: セッション情報の更新
- **機能**:
  - 終了時刻（endDate）の設定
  - セッション内容の追記
  - 関連アイテムの追加

#### FR-082: セッション検索
- **説明**: 日付ベースのセッション検索
- **機能**:
  - 日付範囲での検索
  - カテゴリ別検索
  - 最新セッションの取得

### 2.10 インターフェース機能

#### FR-090: CLIインターフェース
- **説明**: コマンドラインツールとしての機能
- **コマンド**:
  ```bash
  shirokuma list [options]    # 一覧表示
  shirokuma get <id>         # 詳細取得
  shirokuma create [options] # 作成
  shirokuma update <id>      # 更新
  shirokuma delete <id>      # 削除
  shirokuma search <query>   # 検索
  ```

#### FR-091: MCPインターフェース
- **説明**: MCPプロトコル準拠のstdio通信
- **ツール**:
  - get_items
  - get_item_detail
  - create_item
  - update_item
  - delete_item
  - search_items
  - get_current_state
  - update_current_state
  - その他補助ツール

### 2.11 データエクスポート/インポート

#### FR-100: エクスポート機能
- **説明**: データの外部出力
- **形式**:
  - JSON形式
  - CSV形式
  - Markdown形式
- **範囲**:
  - 全データ
  - タイプ別
  - 検索結果

#### FR-101: インポート機能
- **説明**: 外部データの取り込み
- **形式**: JSON形式
- **検証**:
  - スキーマ検証
  - 重複チェック
  - 参照整合性チェック

### 2.12 カレントステート管理機能

#### FR-110: カレントステート保持
- **説明**: システム全体の現在状態を単一アイテムとして管理
- **特徴**:
  - type: "current_state" の特別なアイテム
  - システム全体で1つのみ存在
  - 更新時は既存を上書き（新規作成しない）

#### FR-111: カレントステート更新
- **説明**: AIセッションやタスク進行に応じた状態更新
- **更新内容**:
  - アクティブなセッション情報
  - 進行中のタスク一覧
  - 最近の決定事項
  - 関連アイテムへの参照
- **更新タイミング**:
  - ai-start: セッション開始時
  - ai-finish: セッション終了時
  - manual: 手動更新時

#### FR-112: カレントステート取得
- **説明**: 現在の状態情報を取得
- **用途**:
  - セッション再開時のコンテキスト復元
  - 進捗状況の確認
  - AIによる状況把握

### 2.13 バリデーション機能

#### FR-120: 入力検証
- **説明**: データ入力時の検証
- **検証項目**:
  - 必須フィールドの存在
  - データ型の妥当性
  - 文字数制限
  - 形式チェック（日付、メールアドレス等）
  - 参照整合性

#### FR-121: ビジネスルール検証
- **説明**: ビジネスロジックに基づく検証
- **ルール例**:
  - セッションのstartDateは必須
  - endDateはstartDateより後
  - CRITICALアイテムは自動的に通知対象

### 2.14 インテリジェントGraphDB機能

#### FR-130: AI駆動のコンテンツ分析
- **説明**: アイテム登録時にAIがコンテンツを分析
- **抽出項目**:
  - 日本語キーワード（5-10個）
  - 英語キーワード（5-10個）
  - 概念カテゴリ（authentication, database等）
  - エンティティ（User, AuthService等）
  - 関連トピック

#### FR-131: 自動関連付け
- **説明**: コンテンツ分析に基づく関連アイテムの自動発見
- **関連性判定基準**:
  - キーワードの重複度
  - 概念の一致度
  - エンティティの共通性
  - タイプの関連性
  - 時間的近接性
- **処理**:
  - 関連スコアの計算
  - 上位N件の関連作成
  - 双方向リレーションの維持

#### FR-132: 多言語ブリッジング
- **説明**: 日英混在コンテンツの自動接続
- **機能**:
  - キーワードの自動翻訳
  - 同義語の展開
  - 言語を超えた関連発見
- **辞書管理**:
  - 技術用語の日英マッピング
  - 動的な辞書更新

#### FR-133: 概念クラスタリング
- **説明**: 意味的に関連するアイテムのグループ化
- **処理**:
  - 概念ごとのアイテム分類
  - クラスタ内関連の強化
  - クラスタ間の接続

#### FR-134: グラフ整合性管理
- **説明**: グラフ構造の健全性維持
- **チェック項目**:
  - 存在しないIDへの参照（デッドリンク）
  - 孤立ノード
  - 自己参照
  - 非対称な関連
- **自動修復**:
  - デッドリンクの削除
  - 孤立ノードの接続
  - 双方向性の確保

#### FR-135: スマート検索
- **説明**: インテリジェントな検索機能
- **機能**:
  - クエリの多言語展開
  - 同義語による検索拡張
  - グラフ探索による関連取得
  - 概念ベースの検索

## 3. ユーザーインタラクション要件

### 3.1 エラーハンドリング

#### FR-120: エラーメッセージ
- **説明**: ユーザーフレンドリーなエラー表示
- **要件**:
  - 明確な問題の説明
  - 解決方法の提示
  - エラーコードの付与
  - スタックトレースの制御（開発/本番）

#### FR-121: エラーリカバリ
- **説明**: エラーからの回復支援
- **機能**:
  - 自動リトライ（ネットワークエラー等）
  - 部分的成功の処理
  - ロールバック機能

### 3.2 通知機能

#### FR-130: イベント通知
- **説明**: 重要イベントの通知
- **対象イベント**:
  - CRITICALアイテムの作成
  - ステータス変更
  - 期限切れアラート

## 4. データ処理要件

### 4.1 バッチ処理

#### FR-140: 一括更新
- **説明**: 複数アイテムの一括更新
- **機能**:
  - ステータス一括変更
  - タグ一括付与/削除
  - 優先度一括変更

#### FR-141: 一括削除
- **説明**: 条件に基づく一括削除
- **安全機能**:
  - 削除前確認
  - ドライラン機能
  - 削除履歴の記録

### 4.2 データ整合性

#### FR-150: トランザクション管理
- **説明**: データ一貫性の保証
- **要件**:
  - ACID特性の保証
  - デッドロック回避
  - 楽観的ロック

#### FR-151: 参照整合性
- **説明**: 関連データの整合性維持
- **チェック項目**:
  - 存在しないステータスIDの防止
  - 削除時の関連チェック
  - タグ関連の整合性

## 5. 機能の優先順位

### Priority 1（必須）
- 統一Itemモデル実装
- 基本CRUD操作
- タイプ管理
- ステータス管理
- 検索機能（基本）

### Priority 2（重要）
- タグ管理
- 関連管理
- CLIインターフェース
- MCPインターフェース
- バリデーション

### Priority 3（望ましい）
- エクスポート/インポート
- バッチ処理
- 通知機能
- サジェスト機能

## 6. 受け入れ条件

### 6.1 機能テスト
- すべてのPriority 1機能が動作すること
- 90%以上のPriority 2機能が動作すること
- エラー率が1%未満であること

### 6.2 統合テスト
- CLIとMCPの相互運用性
- データ整合性の維持

### 6.3 ユーザビリティ
- コマンド実行の直感性
- エラーメッセージの明確性
- ドキュメントの完備性

## 7. 除外事項

以下の機能はv0.8.0のスコープ外とします：

- カスタムタイプの追加・削除
- ワークフロー機能
- Web UI
- プラグインシステム

