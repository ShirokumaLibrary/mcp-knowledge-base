---
id: 111
type: spec_requirements
title: "要件定義書: TypeORM移行（v0.9.0）"
status: Specification
priority: HIGH
description: "PrismaからTypeORMへの移行に関する詳細な要件定義（EARS形式）"
aiSummary: "Requirements specification for migrating SHIROKUMA Knowledge Base from Prisma ORM to TypeORM in version 0.9.0, addressing global npm installation issues and improving CLI tool distribution while maintaining data integrity and API compatibility."
tags: ["requirements","ears","typeorm","v0.9.0","migration","spec"]
related: [98,105,108,109,111,5,24,25,26,78,80,110,112,114]
keywords: {"prisma":1,"typeorm":1,"migration":0.9,"database":0.8,"cli":0.8}
concepts: {"database migration":0.95,"orm framework":0.9,"cli tool development":0.85,"software requirements":0.85,"data persistence":0.8}
embedding: "oIKTgICAgICAgJCRgICOj5mAkoCBgICAgICJjoCAjouZg4mAiYCAgICAgYWAgIiDlIqPgI6AgICAgICAgICBgIqNhoCOgICAgICHgoCAgIOii4CAh4CAgICAj4qAgIWLt42DgIGAgICAgImRgICNhbaIjICFgICAgICQjYCAiIw="
createdAt: 2025-08-22T13:32:46.000Z
updatedAt: 2025-08-22T13:32:46.000Z
---

# 要件定義書: TypeORM移行（v0.9.0）

## メタデータ
- **バージョン**: 1.0
- **作成日**: 2025-08-21
- **ステータス**: Specification
- **フェーズ**: Requirements
- **関連イシュー**: #98
- **優先度**: HIGH

## はじめに

### 概要
SHIROKUMA Knowledge Base v0.9.0では、CLIツールとしてのグローバル配布問題を根本的に解決するため、ORMフレームワークをPrismaからTypeORMへ移行します。この移行により、`prisma generate`などのビルド時依存を排除し、実行時の動的な設定解決を実現します。

### ビジネス価値
- **配布の簡素化**: npmグローバルインストールが即座に動作
- **メンテナンス性向上**: スキーマファイルパスの問題から解放
- **開発効率向上**: より直感的なCLIツール開発が可能
- **ユーザー体験改善**: インストール後の追加設定が不要

### スコープ
- Prismaで実装された全データアクセス層のTypeORMへの置換
- 既存データの完全な移行サポート
- MCPツールAPIの互換性維持
- CLIコマンドの透過的な動作保証

## ユーザーストーリー

### ストーリー1: グローバルインストールユーザー
**役割として**: CLIツールをグローバルにインストールするユーザー  
**実現したいこと**: `npm install -g`後に即座にツールを使用  
**価値**: 追加の設定や`prisma generate`なしで作業を開始できる

#### 受入基準
- [ ] `npm install -g @shirokuma/mcp-knowledge-base`が成功する
- [ ] インストール直後に`shirokuma-kb`コマンドが動作する
- [ ] データベース初期化が自動的に実行される
- [ ] エラーメッセージなしで基本コマンドが実行できる

### ストーリー2: 既存データ保有ユーザー
**役割として**: v0.8.xから移行する既存ユーザー  
**実現したいこと**: データを失うことなくv0.9.0へアップグレード  
**価値**: 蓄積した知識ベースを保持したまま新機能を利用できる

#### 受入基準
- [ ] 既存データベースの自動検出が機能する
- [ ] データ移行プロセスが自動的に開始される
- [ ] 移行前にバックアップが作成される
- [ ] 全てのデータとリレーションが保持される

### ストーリー3: 開発者
**役割として**: SHIROKUMA Knowledge Baseを拡張する開発者  
**実現したいこと**: TypeORMのリポジトリパターンで効率的に開発  
**価値**: より保守性の高いコードベースで機能追加ができる

#### 受入基準
- [ ] TypeORMエンティティが明確に定義されている
- [ ] リポジトリパターンが一貫して実装されている
- [ ] トランザクション管理が適切に動作する
- [ ] 型安全性が保証されている

## 機能要件（EARS形式）

### REQ-1: グローバルインストール対応
**WHEN** ユーザーがnpmでグローバルインストールを実行 **THEN** システムは **SHALL** post-installスクリプトなしで正常にインストールを完了する

*理由*: Prismaのschema.prismaファイルパス問題を根本的に解決する

### REQ-2: データベースパス動的解決
**IF** ユーザーが任意のディレクトリからCLIコマンドを実行 **THEN** システムは **SHALL** データベースファイルを正しく検出し初期化する

### REQ-3: 初回実行時の自動セットアップ
**WHEN** ユーザーが初めてCLIコマンドを実行 **THEN** システムは **SHALL** データベースディレクトリを自動作成しマイグレーションを実行する

### REQ-4: 既存データ検出
**IF** v0.8.xのデータベースが存在する **THEN** システムは **SHALL** 自動的に検出し移行プロセスを提案する

### REQ-5: データ移行プロセス
**WHEN** ユーザーがデータ移行を承認 **THEN** システムは **SHALL** トランザクション内で全データを新形式に変換する

### REQ-6: 移行失敗時のロールバック
**IF** データ移行中にエラーが発生 **THEN** システムは **SHALL** 自動的にロールバックし元のデータベースを保持する

### REQ-7: API互換性維持
**WHEN** MCPツールが既存のAPIを呼び出す **THEN** システムは **SHALL** Prisma版と同一のレスポンスを返す

### REQ-8: エンティティリレーション保持
**WHERE** Prismaモデルにリレーションが定義されている場合 **THEN** システムは **SHALL** TypeORMエンティティで同等のリレーションを実装する

### REQ-9: クエリパフォーマンス維持
**WHILE** データベースクエリを実行中 **THEN** システムは **SHALL** Prisma版と同等以上のパフォーマンスを維持する

### REQ-10: 設定ファイル優先順位
**WHEN** データベースパスを決定する際 **THEN** システムは **SHALL** 環境変数、設定ファイル、デフォルトパスの順で優先する

### REQ-11: エラーメッセージの明確化
**IF** TypeORM関連のエラーが発生 **THEN** システムは **SHALL** ユーザーが理解できる明確なエラーメッセージを表示する

### REQ-12: バックアップ作成
**UNLESS** ユーザーが明示的に拒否 **THEN** システムは **SHALL** データ移行前に自動バックアップを作成する

### REQ-13: 並行稼働サポート
**WHERE** 開発環境で実行される場合 **THEN** システムは **SHALL** Prisma版とTypeORM版の並行稼働を許可する

### REQ-14: シード機能
**WHEN** 新規データベースが作成される **THEN** システムは **SHALL** 初期ステータスとタイプをシードする

### REQ-15: トランザクション整合性
**WHILE** 複数テーブルを更新中 **THEN** システムは **SHALL** ACID特性を保証するトランザクション管理を実施する

## 非機能要件

### パフォーマンス
- **クエリ応答時間**: 現行Prisma実装と同等以下（≤100ms for 単純クエリ）
- **データ移行時間**: 1000アイテムあたり30秒以内
- **メモリ使用量**: 現行比20%増加まで許容
- **起動時間**: CLIコマンド実行から応答まで2秒以内

### 信頼性
- **データ整合性**: 移行時のデータ損失ゼロ
- **可用性**: 99.9%以上のコマンド成功率
- **障害回復**: 自動ロールバック機能による復旧
- **バックアップ**: 移行前の自動バックアップ生成

### セキュリティ
- **SQLインジェクション防止**: TypeORMクエリビルダーによる保護
- **パラメータ化クエリ**: 全ユーザー入力のサニタイズ
- **認証情報保護**: データベース接続情報の安全な管理
- **アクセス制御**: ファイルシステムレベルの適切な権限設定

### 保守性
- **コード構造**: リポジトリパターンによる関心の分離
- **ドキュメント**: TypeORMエンティティの自己文書化
- **テスト可能性**: モック可能なリポジトリインターフェース
- **ログ記録**: デバッグ用の詳細なログ出力

## エッジケースとエラーシナリオ

### データベースファイル破損
- **条件**: SQLiteファイルが破損している
- **期待される動作**: エラーを検出し、バックアップからの復元を提案
- **回復方法**: 自動バックアップからの復元コマンド提供

### 権限不足
- **条件**: データベースディレクトリへの書き込み権限がない
- **期待される動作**: 明確なエラーメッセージと代替パスの提案
- **回復方法**: 権限修正手順のガイド表示

### 不完全な移行
- **条件**: 移行プロセスが中断された
- **期待される動作**: 次回起動時に移行の再開または破棄を選択
- **回復方法**: 移行状態のリセットコマンド

### バージョン競合
- **条件**: v0.8.xとv0.9.0が同時にインストールされている
- **期待される動作**: バージョン選択プロンプトの表示
- **回復方法**: 明示的なバージョン指定オプション

## 統合ポイント

### MCP Server
- **インターフェース**: 既存のMCPツール定義を維持
- **データフロー**: リクエスト → サービス層 → TypeORMリポジトリ → SQLite
- **エラーハンドリング**: McpErrorによる統一的なエラー処理

### CLI Commands
- **インターフェース**: Commander.jsコマンドインターフェース
- **データフロー**: コマンド → サービス層 → TypeORMリポジトリ
- **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージ

### AI Services
- **インターフェース**: AIエンリッチメントサービスAPI
- **データフロー**: エンティティ → AI処理 → エンベディング保存
- **エラーハンドリング**: AI処理失敗時のグレースフルデグレード

## 成功指標

- **インストール成功率**: 95%以上のユーザーが問題なくインストール完了
- **データ移行成功率**: 99.9%以上のデータ移行が成功
- **パフォーマンス維持**: 全クエリの90%が現行と同等以下の応答時間
- **ユーザー満足度**: 移行後のサポートリクエスト20%以下

## スコープ外

- PostgreSQLやMySQLなど他のデータベースエンジンのサポート
- GraphQL APIの追加
- データモデルの大幅な変更
- 新機能の追加（移行以外）
- UIコンポーネントの実装