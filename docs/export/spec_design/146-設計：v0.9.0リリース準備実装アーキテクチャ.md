---
id: 146
type: spec_design
title: "設計：v0.9.0リリース準備実装アーキテクチャ"
status: Specification
priority: HIGH
description: "v0.9.0正式版リリースのための実装設計と技術アーキテクチャ"
aiSummary: "Design specification for v0.9.0 release preparation, focusing on removing TypeScript code from command files, cleaning git status, achieving harmony score 1.00, and implementing automated integration testing infrastructure."
tags: ["design","architecture","v0.9.0","release","spec"]
related: [141,142,143,147,148,149,150,151]
keywords: {"design":1,"v0.9.0":1,"release":0.9,"typescript":0.8,"implementation":0.8}
concepts: {"software architecture":0.9,"testing":0.8,"version control":0.8,"release management":0.8,"system design":0.7}
embedding: "gICfkoGAgImAl4CKgICAgICAkZCIgICSgI+AmoCAgYCAgI2Ij4CAlICEgKGAgIeAgIClgI+AgIyAjICagICNgICAmIGJgICCgIKAk4CAjICAgJyAjoCAgICAgI2AgIeAgICqgoaAgIaAiICLgICBgICAq4uAgICQgJOAgYCAgIA="
createdAt: 2025-08-23T06:14:16.000Z
updatedAt: 2025-08-23T06:21:31.000Z
---

# 設計：v0.9.0リリース準備実装アーキテクチャ

## メタデータ
- **バージョン**: 1.2
- **更新日**: 2025-08-23
- **ステータス**: 仕様策定中
- **フェーズ**: 設計
- **要件仕様**: #142
- **関連イシュー**: #141, #143

## 設計概要

### ゴール
- TypeScriptコードをコマンド/エージェントファイルから完全除去
- git statusをクリーンな状態に整理
- ハーモニースコア1.00を達成
- ~~統合テストの自動化基盤を構築~~ → **代替案検討中**
- リリースプロセスを標準化

### 主要な設計判断

1. **判断**: TypeScriptコードブロックをYAML/Markdown記述に置換
   - **理由**: コマンド/エージェントファイルは仕様定義であり実装詳細を含むべきでない
   - **トレードオフ**: 具体的な実装例が減るが、保守性が向上
   - **対象**: `.shirokuma/commands/`内の16ファイル、`.claude/agents/`内の1ファイル

2. **判断**: git statusの未処理ファイルを適切に分類・処理
   - **理由**: クリーンなリリース状態を確保
   - **トレードオフ**: 削除ファイルの履歴は失われるが、不要なものは除去

3. **判断**: ~~統合テストをシェルスクリプトで実装~~ → **再検討中**
   - **問題**: STDIO接続のMCPサーバーの自動テスト方法が未確立
   - **課題**: Claude CLIとMCPサーバー間の通信はSTDIO経由で、外部からの自動テストが困難
   - **代替案検討中**:
     - 手動テストチェックリスト作成
     - MCPサーバー側の単体テスト強化
     - モックを使用した疑似統合テスト

## システムアーキテクチャ

### システムコンテキスト
v0.9.0リリース準備は、既存のSHIROKUMAシステムの品質向上と標準化を目的とした内部改善プロジェクト。

### コンポーネントアーキテクチャ

#### コンポーネント1: ファイルクリーナー
- **目的**: TypeScriptコードブロックの除去と置換
- **責任**: 
  - TypeScriptコードブロックの検出（コマンド/エージェント両方）
  - YAML/Markdown形式への変換
  - ファイルの更新と検証
- **インターフェース**:
  - **入力**: コマンド/エージェントファイルパス
  - **出力**: クリーンなファイル
  - **依存関係**: ファイルシステム、正規表現エンジン

#### コンポーネント2: Git状態マネージャー
- **目的**: git statusの整理と処理
- **責任**:
  - 削除予定ファイルの処理
  - 新規ファイルの分類
  - 適切なコミット作成
- **インターフェース**:
  - **入力**: git status出力
  - **出力**: クリーンなgit状態
  - **依存関係**: gitコマンド

#### ~~コンポーネント3: 統合テストランナー~~ （実装保留）
- **現状**: STDIO接続のMCPサーバーの自動テスト方法が未確立
- **問題点**:
  - Claude CLIはSTDIOでMCPサーバーと通信
  - 外部からのテスト自動化が困難
  - コマンド実行結果の検証方法が不明確

### 技術スタック
- **スクリプト層**: Bash（既存環境との互換性）
  - 理由: すべての環境で動作可能
- **検証層**: ripgrep、sed、awk
  - 理由: 高速で信頼性が高い
- **テスト層**: ~~シェルスクリプト~~ → **手動テスト中心**
  - 理由: STDIO接続の制約により自動化が困難

## データアーキテクチャ

### データモデル

#### ~~テスト結果~~ （保留）
*統合テストが実装できない場合は不要*

#### ハーモニースコア
*システムの整合性スコア*

**フィールド:**
- `score`: number (required) - 0.00-1.00のスコア
- `components`: object (required) - 各コンポーネントのスコア
- `timestamp`: datetime (required) - 測定日時

### データフロー

#### TypeScriptコード除去フロー
1. コマンド/エージェントファイルをスキャン
2. TypeScriptコードブロックを検出
3. 内容を分析して意図を理解
4. YAML/Markdown形式に変換
5. ファイルを更新
6. 変更を検証

## 実装設計

### タスク実行順序

#### Phase 1: TypeScriptコード除去
1. 対象ファイルのリストアップ
   - コマンドファイル: 16ファイル
   - エージェントファイル: 1ファイル（shirokuma-knowledge-curator.md）
2. バックアップ作成
3. 各ファイルの変換実行
4. 変換結果の検証

#### Phase 2: Git状態整理
1. 削除予定ファイルの確認と削除
2. 新規ファイルの必要性確認
3. 適切なコミットメッセージでコミット

#### Phase 3: ~~統合テスト~~ → 手動テスト
1. **手動テストチェックリスト作成**
   - `/kuma:start` コマンドの動作確認
   - `/kuma:issue` コマンドの動作確認
   - `/kuma:spec:*` サブコマンドの動作確認
   - MCP API応答確認（`mcp__shirokuma-kb__get_items`等）
2. **各項目を手動で実行・確認**
3. **結果を文書化**

## エラーハンドリング

### 戦略
失敗を早期に検出し、ロールバック可能な状態を維持する。

### エラータイプ
- **ファイル変換エラー**: TypeScriptコード除去中の失敗
  - 回復: バックアップから復元
- **Git操作エラー**: コミット失敗
  - 回復: git resetで前の状態に戻す
- **手動テスト失敗**: 機能の不具合発見
  - 回復: 問題を修正して再テスト

## テストアプローチ

### MCPサーバー単体テスト
- `npm test`で実行可能な既存テストの活用
- カバレッジ目標: 既存テストの維持

### 手動統合テスト
- チェックリスト形式での動作確認
- 主要シナリオ: start, issue, spec:*, go, commit
- 結果の文書化と共有

### 将来の改善案
- MCPテストツールの開発待ち
- Claude CLI側のテスト機能追加待ち
- 代替テスト手法の継続調査

## セキュリティ考慮事項

### ファイルアクセス
- **緩和策**: 適切な権限でファイルアクセス
- **実装**: 書き込み前にバックアップ作成

### コマンド実行
- **緩和策**: 入力検証とサニタイゼーション
- **実装**: シェルエスケープの適用

## パフォーマンス目標

- **ファイル変換**: 1ファイルあたり<1秒
  - 測定: time コマンドで計測
- **手動テスト実行**: 全体で<10分
  - 測定: 手動計測
- **git操作**: 各操作<2秒
  - 測定: git実行時間

## 移行戦略

### アプローチ
段階的な変更と検証を繰り返す

### ステップ
1. 開発環境で手動テスト実行
2. TypeScriptコード除去を小規模から開始
3. 各変更後に手動で動作確認
4. 問題がなければ次のファイルへ
5. 全完了後に手動統合テスト

### ロールバックプラン
- gitでコミット前の状態に戻す
- バックアップファイルから復元

## 対象ファイル詳細

### コマンドファイル（16ファイル）
- `.shirokuma/commands/kuma/vibe/spec.md`
- `.shirokuma/commands/kuma/vibe/commit.md`
- `.shirokuma/commands/kuma/spec/validate.md`
- `.shirokuma/commands/kuma/spec/refine.md`
- `.shirokuma/commands/kuma/spec/design.md`
- `.shirokuma/commands/kuma/spec/when.md`
- `.shirokuma/commands/kuma/spec/quick.md`
- `.shirokuma/commands/kuma/spec/micro.md`
- `.shirokuma/commands/kuma/spec/req.md`
- `.shirokuma/commands/kuma/spec/tasks.md`
- `.shirokuma/commands/kuma/spec/check.md`
- `.shirokuma/commands/kuma/spec.md`
- `.shirokuma/commands/shared/steering-loader.markdown`
- `.shirokuma/commands/shared/mcp-rules.markdown`
- `.shirokuma/commands/shared/spec-templates.markdown`

### エージェントファイル（1ファイル）
- `.claude/agents/shirokuma-knowledge-curator.md`

## 未解決の質問

1. TypeScriptコード除去後、ドキュメントの具体性は十分か？
2. **STDIO接続のMCPサーバーの自動テスト方法は？**（最重要）
3. 手動テストで十分な品質保証が可能か？
4. MCPテストツールの将来的な提供予定は？