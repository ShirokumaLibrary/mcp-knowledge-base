---
id: 67
type: issue
title: "エクスポートデータからのインポート機能実装"
status: Review
priority: HIGH
aiSummary: "エクスポートデータからのインポート機能実装 エクスポートしたMCPアイテムとcurrent_stateを再インポートする機能の実装。データ復元、マイグレーション、バックアップリストアに必要 ## 背景\n\n現在、ExportManager機能により以下の形式でデータをエクスポート可能：\n- 通常アイテム: `{type}/{id}-{slug}.md`\n- current_state: `.syst"
tags: ["cli","feature","export","import","backup","migration"]
keywords: {"current_state":0.57,"issue":0.41,"string":0.41,"export":0.41,"shirokuma":0.33}
embedding: "gICAjoCAgICAkoCKg4CAk4CAgImAioCAgJeAj4yAgIyAgICPgJ6AgICdgI2TgICSgICAjoCZgICAkoCFkYCAkoCAgIeAo4CAgISAgJOAgJyAgICAgKCAgICLgIOPgICjgICAgICegICAh4CAhoCApoCAgIeAiYCAgIuAg4CAgJ8="
related: [56,62,65,71,85,88]
searchIndex: "current_state string export issue matter promise item shirokuma import front"
created: 2025-08-14T11:02:02.050Z
updated: 2025-08-14T13:00:31.421Z
---

# エクスポートデータからのインポート機能実装

## Description

エクスポートしたMCPアイテムとcurrent_stateを再インポートする機能の実装。データ復元、マイグレーション、バックアップリストアに必要

## Content

# エクスポートデータからのインポート機能実装 ✅

## 実装完了内容

### 1. ImportManagerクラス実装 ✅
- **パス**: `/src/services/import-manager.ts`
- **機能**:
  - `parseFrontMatter`: gray-matterによる安全なYAML解析
  - `importItem`: 単一ファイルインポート（セキュリティ検証付き）
  - `importDirectory`: ディレクトリ一括インポート（再帰対応）
  - `importCurrentState`: システム状態インポート
  - `handleDuplicates`: 重複処理戦略（skip/overwrite/merge）

### 2. セキュリティ対策 ✅
- **パストラバーサル防止**: ファイルパス検証
- **ファイルサイズ制限**: 10MBまで
- **Front Matter検証**: gray-matter使用で安全な解析
- **型検証**: validateType()による厳格な検証
- **トランザクション処理**: データ整合性保証

### 3. CLIコマンド実装 ✅
```bash
# 単一ファイルインポート
shirokuma-kb import file ./export/issue/1-fix-bug.md

# ディレクトリ一括インポート
shirokuma-kb import dir ./export --type issue

# current_stateインポート
shirokuma-kb import state ./export/.system/current_state/latest.md

# 全データインポート
shirokuma-kb import all ./export --merge-strategy overwrite
```

### 4. テストカバレッジ ✅
- **テストファイル**: `/tests/services/import-manager.test.ts`
- **テストケース**: 13個全てパス
- **カバレッジ**: Front Matter解析、CRUD操作、重複処理、エラーハンドリング

### 5. 依存関係追加 ✅
```json
{
  "gray-matter": "^4.0.3",  // YAML Front Matter解析
  "ora": "^8.0.1"           // CLIスピナー表示
}
```

## 動作確認済み

### テスト実行結果
```
✓ 全テストスイート成功（155/155テスト）
✓ ImportManagerテスト（13/13）
✓ 統合テスト成功
```

### CLIコマンド動作確認
```bash
# エクスポート
shirokuma-kb export --type issue --limit 1
# ✓ Exported 1 item(s)

# インポート（既存スキップ）
shirokuma-kb import file docs/export/issue/69-*.md --strategy skip
# ℹ Item skipped (already exists)

# 新規インポート
shirokuma-kb import file test-import.md
# ✓ Imported item 76: Test Import Item
```

## 技術的詳細

### 重複処理戦略
1. **skip**: 既存アイテムはスキップ（デフォルト）
2. **overwrite**: 既存アイテムを上書き
3. **merge**: タグと関連をマージ

### ID管理
- `--preserve-ids`: オリジナルIDを保持
- デフォルト: 新規ID採番

### エラーハンドリング
- 不正なFront Matter形式 → エラーメッセージ
- 必須フィールド欠落 → バリデーションエラー
- ファイルアクセス権限 → セキュリティエラー
- データベース制約違反 → トランザクションロールバック

## レビュー結果対応

### セキュリティ改善実施 ✅
1. パストラバーサル対策実装
2. gray-matter導入でYAML解析セキュア化
3. ファイルサイズ制限追加
4. トランザクション処理実装

### パフォーマンス最適化
- バッチ処理の基盤実装済み
- 今後の改善余地: 並列処理、ストリーミング

## 次のステップ

1. 大量データインポートのパフォーマンステスト
2. プログレスバー表示の実装
3. インポートログの記録機能
4. データマイグレーション用スクリプト作成

## 関連イシュー
- issue-62: エクスポート機能にcurrent_state含める（Review段階）
- issue-56: エクスポート機能実装（完了）

## AI Summary

エクスポートデータからのインポート機能実装 エクスポートしたMCPアイテムとcurrent_stateを再インポートする機能の実装。データ復元、マイグレーション、バックアップリストアに必要 ## 背景

現在、ExportManager機能により以下の形式でデータをエクスポート可能：
- 通常アイテム: `{type}/{id}-{slug}.md`
- current_state: `.syst

## Keywords (Detailed)

- current_state (weight: 0.57)
- issue (weight: 0.41)
- string (weight: 0.41)
- export (weight: 0.41)
- shirokuma (weight: 0.33)
- item (weight: 0.33)
- import (weight: 0.33)
- matter (weight: 0.33)
- promise (weight: 0.33)
- front (weight: 0.25)

