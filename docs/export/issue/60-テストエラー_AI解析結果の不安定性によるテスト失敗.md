---
id: 60
type: issue
title: "テストエラー: AI解析結果の不安定性によるテスト失敗"
status: Completed
priority: HIGH
description: "AIエンリッチメントのテストが毎回異なる結果を返すため失敗している。ClaudeInterfaceの実際のAI呼び出しをスタブ化する必要がある。"
aiSummary: "テストエラー: AI解析結果の不安定性によるテスト失敗 AIエンリッチメントのテストが毎回異なる結果を返すため失敗している。ClaudeInterfaceの実際のAI呼び出しをスタブ化する必要がある。 ## 問題の詳細\n\nテストでエラーが発生しており、特にAIエンリッチメント関連のテストで問題が見られる。\n\n### 根本原因\n- ClaudeInterfaceが実際のClaude CLIを呼び出し"
tags: ["ai-enrichment","testing","mock","stub","test-stability","claude-interface"]
related: [18,26,27,40,45,46]
keywords: {"test":0.63,"enrichment":0.63,"content":0.52,"claudeinterface":0.52,"update":0.42}
embedding: "gICjgI6MgYeDlYCAgJmAgICAq4CLgoCAioqAgYCQgICAgKSAhImGgo6BgIeAm4CAgICQgICAjICMgYCNgJqAgICAgYCCgo6EhYuAjYCOgICAgIWAiI2JjYqWgIiAgoCAgICRgI6WgpODl4CMgIGAgICAnoCNloeQgJeAhoCMgIA="
createdAt: 2025-08-22T13:32:43.000Z
updatedAt: 2025-08-22T13:32:43.000Z
---

## 問題の詳細

テストでエラーが発生しており、特にAIエンリッチメント関連のテストで問題が見られる。

### 根本原因
- ClaudeInterfaceが実際のClaude CLIを呼び出している
- AIの解析結果が毎回微妙に異なる（非決定的）
- キーワード抽出や概念検出の結果が一定しない

### 実装された解決策

1. **ClaudeInterfaceのモック化**
   - `tests/mocks/claude-interface.mock.ts`を作成
   - 決定的な結果を返すスタブを実装
   - テキスト内容に基づく予測可能なキーワード抽出
   
2. **テストファイルの更新**
   - `enhanced-ai-enrichment.test.ts` - vi.doMockを使用した動的モック
   - `ai-enrichment-update.test.ts` - テスト仕様の修正（title/description変更時にAIエンリッチメント実行）
   - `update-item-enrichment.test.ts` - CRUDHandlersの正しいインポート

### モック実装の詳細

#### 動的モックアプローチ（vi.doMock）
```typescript
beforeEach(async () => {
  vi.resetModules();
  
  // Mock ClaudeInterface
  mockExtractWeightedKeywords = vi.fn();
  vi.doMock('../../../src/services/ai/claude-interface.js', () => ({
    ClaudeInterface: vi.fn(() => ({
      extractWeightedKeywords: mockExtractWeightedKeywords
    }))
  }));
  
  // Import after mocks
  const module = await import('../../../src/services/enhanced-ai.service.js');
  EnhancedAIService = module.EnhancedAIService;
});
```

#### コンテンツ認識型モック
```typescript
mockExtractWeightedKeywords.mockImplementation(async (content) => {
  const text = `${content.title} ${content.description} ${content.content}`.toLowerCase();
  const keywords = [];
  
  // テキストに基づいたキーワード生成
  if (text.includes('react')) {
    keywords.push({ keyword: 'react', weight: 0.9 });
  }
  // ... 他のパターン
  
  return { keywords, concepts, embedding, summary };
});
```

### 結果
- **テスト成功率向上**: 失敗テスト数が35から22に減少
- **enhanced-ai-enrichment.test.ts**: 13/13テスト成功
- **ai-enrichment-update.test.ts**: title/description変更時のAIエンリッチメント実行を確認

### 残課題
- 他のテストファイル（update-item-enrichment.test.ts等）のモック統合
- integrationテストのデータベース問題の解決