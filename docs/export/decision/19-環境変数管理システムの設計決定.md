---
id: 19
type: decision
title: "環境変数管理システムの設計決定"
status: Ready
priority: MEDIUM
tags: ["design","configuration","environment","issue-56"]
related: [14,15,56,58,59,8,51,53,99,106]
keywords: {"environment":1,"variable":1,"configuration":0.9,"management":0.9,"config":0.9}
concepts: {"configuration management":0.95,"environment variables":0.95,"database":0.8,"data export":0.8,"development operations":0.8}
embedding: "hICAgIqAiYCAgICegpCPgYCAgICBgIGAgICAoIuRlIeCgICAgYCBgICAgJWRlZCNioCAgIuAiYCAgICHkJyUjISAgICUgJKAgICAg5KojYaMgICAloCUgICAgI+OpISBkICAgI2AjICAgICRhZqAhIyAgICDgJKAgICAkYCUhYA="
createdAt: 2025-08-22T13:32:41.000Z
updatedAt: 2025-08-22T13:32:41.000Z
---

# 環境変数管理システムの設計決定

Issue-56: 環境変数管理とエクスポート機能の実装設計

## AI Summary

Design decision for implementing environment variable management system with export/import functionality, CLI commands, and multi-environment support for database configuration and API keys.

## 設計目標
1. 環境変数の一元管理
2. 設定のエクスポート/インポート機能
3. 開発環境と本番環境の切り替え容易性
4. 設定の可視化とドキュメント化

## 現状分析
### 使用されている環境変数
- DATABASE_URL: Prismaデータベース接続
- SHIROKUMA_DATA_DIR: データディレクトリ
- SHIROKUMA_EXPORT_DIR: エクスポートディレクトリ
- ANTHROPIC_API_KEY: Claude API (暗黙的に使用)
- NODE_ENV: 環境種別（開発/本番）

### 問題点
- .env.exampleファイルが存在しない
- 環境変数の説明が不足
- 環境切り替えが手動
- 設定のバックアップ/共有が困難

## 実装方針

### 1. ConfigManagerクラスの実装
```typescript
// src/services/config-manager.ts
class ConfigManager {
  // 環境変数の定義と検証
  private schema: ConfigSchema
  
  // 現在の設定取得
  getConfig(): Config
  
  // 設定のエクスポート
  exportConfig(format: 'env' | 'json'): string
  
  // 設定のインポート
  importConfig(data: string, format: 'env' | 'json'): void
  
  // 環境の切り替え
  switchEnvironment(env: 'development' | 'production' | 'test'): void
  
  // 設定の検証
  validateConfig(): ValidationResult
}
```

### 2. CLIコマンドの追加
```bash
# 設定表示
shirokuma-kb config show

# 設定エクスポート
shirokuma-kb config export [--format=env|json] [--output=file]

# 設定インポート
shirokuma-kb config import <file>

# 環境切り替え
shirokuma-kb config env <development|production|test>

# 設定検証
shirokuma-kb config validate
```

### 3. ファイル構造
```
.shirokuma/
├── config/
│   ├── default.env       # デフォルト設定
│   ├── development.env   # 開発環境設定
│   ├── production.env    # 本番環境設定
│   └── test.env         # テスト環境設定
├── data/                # データベース（既存）
└── export/              # エクスポート先（既存）

プロジェクトルート/
├── .env                 # 現在の設定（gitignore）
├── .env.example         # サンプル設定（新規作成）
└── .env.local          # ローカル上書き設定（gitignore）
```

### 4. 環境変数スキーマ
```typescript
interface ConfigSchema {
  DATABASE_URL: {
    type: 'string',
    required: true,
    description: 'Prisma database connection URL',
    default: 'file:.shirokuma/data/shirokuma.db'
  },
  SHIROKUMA_DATA_DIR: {
    type: 'string',
    required: false,
    description: 'Data directory path',
    default: '.shirokuma/data'
  },
  SHIROKUMA_EXPORT_DIR: {
    type: 'string',
    required: false,
    description: 'Export directory path',
    default: 'docs/export'
  },
  ANTHROPIC_API_KEY: {
    type: 'string',
    required: false,
    description: 'Claude API key (optional)',
    sensitive: true
  },
  NODE_ENV: {
    type: 'enum',
    values: ['development', 'production', 'test'],
    default: 'development'
  }
}
```

## 実装順序
1. ConfigManagerクラスの基本実装
2. 環境変数スキーマの定義
3. CLIコマンドの実装
4. テストの作成
5. .env.exampleファイルの生成
6. ドキュメントの更新

## セキュリティ考慮事項
- APIキーなどのsensitiveフィールドはエクスポート時にマスク
- .envファイルの権限は600に設定
- エクスポートファイルには警告メッセージを含める

## 影響範囲
- 既存のコードへの影響は最小限（環境変数の読み込み方法は変更なし）
- 新規機能として追加するため後方互換性を維持
- 設定ファイルはgitignoreに追加済み
