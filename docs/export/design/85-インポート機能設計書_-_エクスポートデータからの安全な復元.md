---
id: 85
type: design
title: "インポート機能設計書 - エクスポートデータからの安全な復元"
description: "Gitリポジトリでエクスポート済みドキュメントを共有し、クローンした人がデータベースを再構築するための機能仕様書"
status: Open
priority: HIGH
aiSummary: "Technical design document for implementing import functionality to restore exported MCP data from Markdown files with Front Matter, focusing on security, performance, and data integrity through transaction-based processing and flexible duplicate handling strategies."
tags: ["design","tdd","security","import","issue-67"]
keywords: {"import":1,"export":0.9,"security":0.9,"data":0.9,"database":0.8}
concepts: {"data_migration":0.95,"security":0.9,"database_management":0.85,"backup_recovery":0.8,"file_processing":0.8}
related: [56,62,67,74,86,88]
created: 2025-08-16T07:16:33.089Z
updated: 2025-08-16T07:32:27.944Z
---

# インポート機能設計書

## 1. 機能概要

### この機能は何をするのか
Gitリポジトリに含まれるエクスポート済みMarkdownファイルから、データベースを構築・再構築する機能です。
チーム間での知識共有とプロジェクト情報の同期を実現します。

### 主な用途
1. **初回セットアップ**: リポジトリクローン後のDB構築
2. **知識共有**: チーム間でのドキュメント共有
3. **プロジェクト同期**: イシュー、ナレッジ、設計書の共有
4. **オンボーディング**: 新メンバーへの情報共有

## 2. 想定される運用フロー

### 2.1 典型的なワークフロー

```mermaid
1. 開発者A: 作業とドキュメント作成
   ↓
2. shirokuma-kb export（定期的に実行）
   ↓
3. git add docs/export && git commit
   ↓
4. git push（GitHubへ）
   ↓
5. 開発者B: git pull
   ↓
6. shirokuma-kb import docs/export
   ↓
7. 開発者Bのローカルに同じ知識ベース構築
```

### 2.2 Gitリポジトリ構造

```
your-project/
├── src/                    # ソースコード
├── docs/
│   └── export/            # MCPエクスポート（Git管理）
│       ├── issue/         # イシュー
│       ├── knowledge/     # 技術知識
│       ├── design/        # 設計書
│       ├── decision/      # 意思決定記録
│       └── .system/       # システム状態
├── .gitignore
└── README.md
```

### 2.3 .gitignore設定

```gitignore
# MCPデータベース（ローカルのみ）
.shirokuma/data/
*.db
*.db-journal

# MCPエクスポートは含める
!docs/export/
```

## 3. コマンド仕様

### 3.1 初回セットアップ（新メンバー）

```bash
# リポジトリクローン
git clone https://github.com/team/project.git
cd project

# MCPデータベース初期化
shirokuma-kb migrate

# エクスポートデータからDB構築
shirokuma-kb import docs/export
# → チームの知識ベースがローカルに構築される
```

### 3.2 日常的な同期

```bash
# 最新のドキュメントを取得
git pull

# データベースを更新（新規追加のみ）
shirokuma-kb import docs/export --sync
# → 新しいアイテムのみ追加、既存は保持
```

### 3.3 完全同期（リセット）

```bash
# ローカルの変更を破棄して完全同期
shirokuma-kb import docs/export --reset
# → Gitのドキュメントと完全に一致させる
```

## 4. インポート戦略

### 4.1 モード別動作

| モード | コマンド | 動作 | 用途 |
|--------|----------|------|------|
| **初回構築**（デフォルト） | `import docs/export` | 空のDBに全データ登録 | 新メンバー、初回セットアップ |
| **同期** | `import docs/export --sync` | 新規のみ追加、既存保持 | 日常的な更新 |
| **リセット** | `import docs/export --reset` | 既存削除して再構築 | 完全同期が必要な時 |
| **ドライラン** | `import docs/export --dry-run` | 変更内容を確認のみ | 実行前の確認 |

### 4.2 ID管理戦略

**Gitで共有する場合はID保持が必須**

- エクスポート時のIDをそのまま使用
- チーム全体で同じIDを共有
- リレーションの整合性を保証

### 4.3 競合処理

| 状況 | --syncモード | --resetモード | デフォルト |
|------|-------------|--------------|------------|
| ローカルのみ存在 | 保持 | 削除 | 保持 |
| リモートのみ存在 | 追加 | 追加 | 追加 |
| 両方に存在（同じ） | スキップ | 上書き | スキップ |
| 両方に存在（異なる） | ローカル優先 | リモート優先 | エラー |

## 5. 使用シナリオ

### シナリオ1: 新メンバーのオンボーディング
```bash
# 1. プロジェクトクローン
git clone https://github.com/team/shirokuma-project.git
cd shirokuma-project

# 2. 依存関係インストール
npm install

# 3. MCPセットアップ
shirokuma-kb migrate

# 4. チームの知識ベース構築
shirokuma-kb import docs/export

# 5. 開発開始（過去のイシュー、決定事項、知識が利用可能）
shirokuma-kb list --type issue
```

### シナリオ2: 日次同期フロー
```bash
# 朝の作業開始時
git pull
shirokuma-kb import docs/export --sync

# 作業中（ローカルで知識追加）
shirokuma-kb create -t knowledge -T "React最適化テクニック"

# 夕方の共有
shirokuma-kb export
git add docs/export
git commit -m "docs: Add React optimization knowledge"
git push
```

### シナリオ3: CI/CDでの自動エクスポート
```yaml
# .github/workflows/export-docs.yml
name: Export MCP Documents
on:
  schedule:
    - cron: '0 0 * * *'  # 毎日深夜
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: shirokuma-kb export
      - uses: peter-evans/create-pull-request@v4
        with:
          title: 'docs: Update MCP exports'
          commit-message: 'docs: Auto-export MCP documents'
```

## 6. エクスポート・インポートのベストプラクティス

### 6.1 エクスポートタイミング
- **イシュー完了時**: 解決済みイシューをエクスポート
- **設計書作成後**: レビュー済み設計書をエクスポート
- **重要な決定後**: decision記録をエクスポート
- **週次/日次**: 定期的な自動エクスポート

### 6.2 Gitコミットルール
```bash
# 良い例
git commit -m "docs: Add authentication design (design-85)"
git commit -m "docs: Update issue-67 status to completed"
git commit -m "docs: Add TDD best practices knowledge"

# 悪い例
git commit -m "Update files"  # 不明確
git commit -m "Export"        # 内容不明
```

### 6.3 ブランチ戦略
- **main**: 確定したドキュメントのみ
- **feature**: 作業中のドキュメント
- **プルリクエスト**: ドキュメントレビュー

## 7. 技術仕様

### 7.1 ファイル形式
```markdown
---
id: 67
type: issue
title: "インポート機能実装"
status: Review
priority: HIGH
tags: ["import", "feature"]
related: [56, 62, 71]
created: 2025-08-14T11:02:02.050Z
updated: 2025-08-14T13:00:31.421Z
---

# インポート機能実装
内容...
```

### 7.2 必須フィールド
- `id`: 一意識別子（チーム全体で共有）
- `type`: アイテムタイプ
- `title`: タイトル
- `status`: ステータス

### 7.3 AI関連フィールド（オプション）
- `keywords`: インポート時に再生成可能
- `concepts`: インポート時に再生成可能
- `embedding`: 通常は除外（サイズ削減）

## 8. セキュリティと制限

### 8.1 セキュリティ
- パストラバーサル防止
- SQLインジェクション対策
- YAMLインジェクション対策

### 8.2 制限事項
- 単一ファイル: 最大10MB
- 合計: 最大1GB
- 同時インポート: 最大1000アイテム

### 8.3 パフォーマンス
- 100アイテム: 約2秒
- 1000アイテム: 約10秒
- 10000アイテム: 約100秒

## 9. エラー処理

| エラー | 原因 | 対処法 |
|--------|------|--------|
| "ID conflict" | ID重複 | --syncまたは--reset使用 |
| "Invalid format" | Markdownフォーマット不正 | ファイルを修正 |
| "Missing required field" | 必須フィールド不足 | Front Matter追加 |
| "Directory not found" | docs/exportが存在しない | git pullまたはexport実行 |

## 10. FAQ

**Q: プライベートな情報はどう扱う？**
A: .gitignoreに特定ディレクトリを追加し、エクスポート対象から除外します。

**Q: 大きなプロジェクトでパフォーマンスは？**
A: 1万アイテムまでは問題なく動作。それ以上は分割エクスポートを推奨。

**Q: ローカル変更とリモート変更が競合したら？**
A: --syncモードではローカル優先、--resetモードではリモート優先です。

**Q: AIフィールド（embedding等）は必要？**
A: 通常は不要です。インポート時に再生成されます。

**Q: 既存プロジェクトへの導入は？**
A: 初回エクスポート → Git追加 → チームで共有の流れで導入可能です。

## 11. 実装優先度

### Phase 1（必須）✅
- [x] 基本インポート機能
- [x] ID保持
- [x] エラーハンドリング

### Phase 2（推奨）
- [ ] --sync モード（日常同期用）
- [ ] --reset モード（完全同期用）
- [ ] --dry-run（確認用）
- [ ] プログレス表示

### Phase 3（拡張）
- [ ] 差分表示
- [ ] 競合解決UI
- [ ] 選択的インポート

## 12. 成功基準

1. **互換性**: エクスポートファイルを100%インポート可能
2. **共有性**: チーム全体で同じ知識ベースを構築可能
3. **追跡性**: Gitでドキュメントの変更履歴を管理可能
4. **簡便性**: 3コマンド以内でセットアップ完了
5. **安全性**: 既存データの意図しない削除を防止