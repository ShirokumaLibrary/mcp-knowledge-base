---
allowed-tools: Bash(git add:*), Bash(git status:*), Bash(git commit:*), Bash(git diff:*), Bash(npm run build:*), Bash(npm test:*), Bash(npm version:*), Bash(npm publish:*), Bash(npm whoami:*), Bash(npm pack:*)
description: Commit changes following project guidelines and handle releases
---

## Context

- Current git status: !`git status`
- Current git diff (staged and unstaged changes): !`git diff HEAD`
- Current branch: !`git branch --show-current`
- Recent commits: !`git log --oneline -5`

## Task

@.claude/agents/LANG.markdown

<ultrathink>
I need to:
1. Run all tests first to ensure nothing is broken
2. If tests fail, stop the commit process immediately
3. If tests pass, analyze the current git status and diff
4. Commit changes in the proper order: source code, tests, distribution files, and documentation
5. Ensure no AI references are included in commit messages
</ultrathink>

### Pre-commit Check (Optimized)

**SMART: Analyze changes and run appropriate checks**

```bash
# Use external script for change detection
# Source common functions for access to environment variables
source .claude/tools/lib/common.sh

# Run the check script to analyze changes
.claude/tools/check-markdown-only.sh
CHECK_RESULT=$?

# The script exports these variables:
# - SKIP_CHECKS (true/false)
# - CHANGE_TYPE (markdown/code/mixed/none/forced)
# - MARKDOWN_COUNT (number)
# - CODE_COUNT (number)

# Determine if we need to run tests
if [ "$SKIP_CHECKS" = true ]; then
  echo "üìù No code changes detected"
  echo "   Markdown files: $MARKDOWN_COUNT"
  echo "   ‚è±Ô∏è  Skipping tests (saves ~25 seconds)"
  echo "   Only documentation/markdown files will be committed"
  
  # Show files in verbose mode
  if [ "${VERBOSE:-false}" = true ]; then
    ALL_CHANGES=$(get_all_changes)
    echo "   Files to commit:"
    echo "$ALL_CHANGES" | head -10 | sed 's/^/     - /'
    TOTAL_COUNT=$(echo "$ALL_CHANGES" | wc -l)
    [ $TOTAL_COUNT -gt 10 ] && echo "     ... and $((TOTAL_COUNT - 10)) more"
  fi
else
  echo "üîç Code/Config changes detected"
  echo "   Code files: $CODE_COUNT"
  echo "   Running tests before commit..."
  
  npm test
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Tests failed - STOP! Do not proceed with commits"
    echo "   Fix the failing tests before committing"
    exit 1
  fi
  
  echo "‚úÖ All tests passed - safe to commit"
fi
```

**If tests fail:**
- ‚ùå STOP immediately - do not proceed with commits
- Fix all failing tests first
- Run tests again to confirm

Execute conventional commits in this specific order:

### 1. Source Code
```bash
git add src/ --exclude='*.test.ts' --exclude='*.spec.ts' --exclude='__tests__'
git add package.json tsconfig.json
```

### 2. Test Code
```bash
git add src/**/*.test.ts src/**/*.spec.ts src/__tests__/
```

### 3. Distribution Files  
```bash
# Conditional build step - only build if code changed
if [ "$SKIP_CHECKS" != true ]; then
  echo "üî® Building distribution files..."
  npm run build  # MUST use production build, not dev
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Build failed - cannot proceed with commit"
    exit 1
  fi
  
  git add dist/
  echo "‚úÖ Distribution files built and staged"
else
  echo "üìù No code changes - Skipping build step"
  echo "   Distribution files remain unchanged"
fi
```

### 4. Documentation
```bash
git add docs/ *.md
```

## Critical Rules

1. **Always run tests before committing** - if tests fail, STOP immediately
2. **Never include AI references in commits** (no "generated by", "created with AI", etc.)
3. **Always use production build** for dist/ (excludes tests, maps, .d.ts)
4. **Semantic versioning**: patch=fixes, minor=features, major=breaking

## Version Release

<ultrathink>
If a version release is requested, I need to:
1. Determine if this is a patch, minor, or major version bump based on the changes
2. Update the CHANGELOG.md with the new version
3. Use npm version to create the release commit and tag
4. Push the changes and publish to npm
</ultrathink>

When requested (e.g., "bump version by 0.0.1"):

1. Update CHANGELOG.md (move [Unreleased] to new version)
2. `git commit -m "docs: update CHANGELOG for vX.X.X"`
3. `npm version patch/minor/major -m "chore: release v%s"`
4. `git push && git push --tags`
5. `npm publish`

## CHANGELOG Format

```markdown
## [Unreleased]
### Added/Changed/Fixed

## [0.0.9] - 2024-01-15
### Added
- User-facing feature description
```

Focus on user impact, not implementation details.